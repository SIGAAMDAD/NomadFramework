name: ğŸš€ CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        dotnet: ['10.0.x']
    
    runs-on: ${{ matrix.os }}
    name: Test on ${{ matrix.os }} with .NET ${{ matrix.dotnet }}
    
    steps:
    # Step 1: Checkout code (updated to v4)
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      timeout-minutes: 5
    
    # Step 2: Setup .NET
    - name: âš™ï¸ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ matrix.dotnet }}
      timeout-minutes: 5
    
    # Step 3: Restore dependencies
    - name: ğŸ“¦ Restore packages
      run: dotnet restore
      timeout-minutes: 5
    
    # Step 4: Build
    - name: ğŸ”¨ Build solution
      run: dotnet build --configuration Release --no-restore
      timeout-minutes: 10
    
    # Step 5: Run tests
    - name: ğŸ§ª Run all tests
      run: |
        # Find ALL test projects in the repo
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          # Windows PowerShell command
          Get-ChildItem -Path . -Recurse -Filter "*.csproj" | Where-Object { $_.Name -match "(Test|\.Tests)" } | ForEach-Object {
            echo "ğŸ“ Testing: $($_.FullName)"
            dotnet test $_.FullName --configuration Release --verbosity minimal --no-build
          }
        else
          # Linux/Mac bash command
          find . -name "*.Tests.csproj" -o -name "*Test.csproj" | while read project; do
            echo "ğŸ“ Testing: $project"
            dotnet test "$project" --configuration Release --verbosity minimal --no-build
          done
        fi
        
        # If no test projects found, succeed anyway
        if [ $? -eq 1 ]; then
          echo "âš ï¸ No test projects found"
        fi
      timeout-minutes: 10
    
    # Step 6: Upload test results (UPDATED to v4)
    - name: ğŸ“Š Upload test results
      if: always()  # Run even if tests fail
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.os }}
        path: TestResults/
        if-no-files-found: ignore
      timeout-minutes: 10
  
  # Job 2: Build & Package
  build:
    needs: test  # Only run if ALL test jobs pass
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      timeout-minutes: 5
    
    - name: âš™ï¸ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
      timeout-minutes: 5
    
    - name: ğŸ”¨ Build Release
      run: |
        dotnet publish --configuration Release --output ./publish --self-contained false
      timeout-minutes: 15
    
    - name: ğŸ“¦ Package artifacts
      run: |
        cd publish
        zip -r ../release-${{ github.sha }}.zip .
      timeout-minutes: 15
    
    - name: ğŸš€ Upload release
      uses: actions/upload-artifact@v4
      with:
        name: release-package
        path: release-${{ github.sha }}.zip
        if-no-files-found: error
      timeout-minutes: 15