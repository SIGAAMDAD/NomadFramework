name: âš¡ Optimized CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        dotnet-version: ['10.0.x']
    
    runs-on: ${{ matrix.os }}
    timeout-minutes: 25
    
    env:
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: âš™ï¸ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ matrix.dotnet-version }}
    
    # CACHE for faster builds
    - name: ğŸ’¾ Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
    
    - name: ğŸ’¾ Cache build output
      uses: actions/cache@v4
      with:
        path: |
          ~/.local/share/NuGet
          ~/.nuget
          **/bin
          **/obj
        key: ${{ runner.os }}-build-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-build-
    
    # WINDOWS-SPECIFIC OPTIMIZATIONS
    - name: ğŸªŸ Windows optimizations
      if: runner.os == 'Windows'
      run: |
        # Disable Windows Defender during build (temporary)
        Set-MpPreference -DisableRealtimeMonitoring $true
        # Clean temp files
        Remove-Item -Path "$env:TEMP\*" -Recurse -Force -ErrorAction SilentlyContinue
        # Increase process priority
        $process = Get-Process -Id $PID
        $process.PriorityClass = [System.Diagnostics.ProcessPriorityClass]::High
    
    - name: ğŸ“¦ Restore packages
      run: dotnet restore
    
    - name: ğŸ”¨ Build for multiple frameworks
      run: |
        # Build for all target frameworks in your csproj
        dotnet build --configuration Release --no-restore --verbosity minimal
        
        # Or force specific frameworks:
        # dotnet build -f net10.0 --configuration Release
        # dotnet build -f netstandard2.1 --configuration Release
    
    - name: ğŸ§ª Run tests for each target framework
    
    - name: ğŸ§ª Run tests (Linux)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        echo "Testing with .NET ${{ matrix.dotnet-version }} on ${{ matrix.os }}"
        find . -name "*Test*.csproj" | while read project; do
          echo "Testing: $(basename $project)"
          dotnet test "$project" --configuration Release --no-build
        done

    - name: ğŸ§ª Run tests (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        echo "Testing with .NET ${{ matrix.dotnet-version }} on ${{ matrix.os }}"
        $testProjects = Get-ChildItem -Path . -Recurse -Filter "*Test*.csproj"
        foreach ($proj in $testProjects) {
          echo "Testing: $($proj.Name)"
          dotnet test $proj.FullName --configuration Release --no-build
        }
      timeout-minutes: 15